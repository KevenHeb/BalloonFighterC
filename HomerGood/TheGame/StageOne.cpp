#include "StageOne.h"
#include "Engine.h"

homer::StageOne::~StageOne()
{
	Engine::Get().WorldService().RemoveAllEntities();
	m_Spawner.ClearPrefabs();
}

void homer::StageOne::Load()
{
	IAudio& audio = Engine::Get().Audio();
	size_t music_id = audio.LoadMusic("Assets/start_theme.wav");
	audio.PlayMusic(music_id, 1);

	int m_TileWidth = 32;
	int m_TileHeight = 32;

	Entity* background = homer::Engine::Get().WorldService().Create("TileMap");
	background->AddComponent<Tilemap>()->Load("Assets/bf_tilemap.png", 25, 19, m_TileWidth, m_TileHeight);

	RectF a{
		32,430,24,48
	};

	RectF b{
		350,240,24,48
	};

	RectF c{
		300,240,24,48
	};

	Entity* player = homer::Engine::Get().WorldService().Create("Player");
	player->SetPosition(a);

	m_Spawner.Init();

	Entity* e2 = m_Spawner.Spawn("Enemy");
	Entity* e3 = m_Spawner.Spawn("Enemy");

	e2->SetPosition(b);
	e3->SetPosition(c);

	m_Enemies = 2;
	Engine::Get().WorldService().SetNumberEnemies(m_Enemies);

	player->AddComponent<PlayerController>();

	TLayer foreLayer = {
		{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
		{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
		{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,9,10,0,0,0},
		{0,0,0,0,0,0,0,0,0,0,0,0,9,10,0,0,0,0,0,0,25,26,0,0,0},
		{0,0,0,0,9,10,0,0,0,0,0,0,25,26,0,0,0,0,0,0,0,0,0,0,0},
		{0,0,0,0,25,26,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
		{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
		{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,9,10,0,0,0,0,0},
		{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,25,26,0,0,0,0,0},
		{0,0,0,0,0,0,0,0,5,6,6,6,6,6,6,7,0,0,0,0,0,0,0,0,0},
		{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
		{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
		{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
		{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
		{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
		{5,6,6,6,6,7,0,0,0,0,0,0,0,0,0,0,0,0,0,5,6,6,6,6,7},
		{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
		{53,53,53,53,53,53,53,53,53,53,53,53,53,53,53,53,53,53,53,53,53,53,53,53,53},
		{37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37,37}
	};

	background->GetComponent<Tilemap>()->AddLayer("Foreground", foreLayer);

	TLayer backLayer = {
		{24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24},
		{24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24},
		{24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,9,10,24,24,24},
		{24,24,24,24,24,24,24,24,24,24,24,24,9,10,24,24,24,24,24,24,25,26,24,24,24},
		{24,24,24,24,9,10,24,24,24,24,24,24,25,26,24,24,24,24,24,24,24,24,24,24,24},
		{24,24,24,24,25,26,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24},
		{24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24},
		{24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,9,10,24,24,24,24,24},
		{24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,25,26,24,24,24,24,24},
		{24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24},
		{24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24},
		{24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24},
		{24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24},
		{24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24},
		{24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24},
		{24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24},
		{24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24},
		{24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24},
		{24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24}
	};

	background->GetComponent<Tilemap>()->AddLayer("Background", backLayer);
}

void homer::StageOne::ClearSpawner()
{
	m_Spawner.ClearPrefabs();
}
